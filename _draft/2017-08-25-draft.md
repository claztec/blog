---
layout: post
title: Spring Boot + AngularJS 웹소캣 적용하기
author: Derek Choi
comments: true
---
트위터 앱에 리트윗과 좋아요를 다른 사람이 누르면 새로 고침 없이 카운트가 반영이 되는걸 볼 수 있다.
이런 효과를 주기 위해 서비스에 웹소캣을 적용해 보기로 했다.

## Spring Boot 설정
디펜던시 추가
build.gradle 에 spring-boot-starter-websocket 을 추가한다.

```
    compile "org.springframework.boot:spring-boot-starter-websocket:$spring_boot_version"

```

WebSocketConfig.java 추가
웹소캣 설정에 대한 파일을 만든다. 
```java
import org.springframework.context.annotation.Configuration;
import org.springframework.messaging.simp.config.MessageBrokerRegistry;
import org.springframework.web.socket.config.annotation.AbstractWebSocketMessageBrokerConfigurer;
import org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
import org.springframework.web.socket.config.annotation.StompEndpointRegistry;

@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig extends AbstractWebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/v3/promotion/stylers/like");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/gs-guide-websocket").withSockJS();
    }

}
```
이후 자바스크립트에서 SockJS 객체를 만들때 registerStompEndpoints 함수에서 추가한 gs-guide-websocket 을 사용하게 된다. 이름은 변경이 가능하다.
configureMEssageBroker 에서 config.enableSimpleBroker 에서 클라이언트로 메시지를 보낼 수 있도록 브로커를 설정하였다.

StylerPromotionController.java
서버에서 웹소캣을 사용하는 부분.


 
```java
@RestController
@Slf4j
public class StylerPromotionController {

    @NoAuthCheck
    @RequestMapping(value = "/v2/promotion/stylers/{stylerCode}/like", method = RequestMethod.GET)
    public StylerPromotionLikeResponse getStylerLikeCount(@PathVariable String stylerCode) {

        StylerLikeDto stylerLikeDto = stylerLikeService.getStylerLikeCount(stylerCode);

        return StylerPromotionLikeResponse.create(stylerLikeDto);
    }

    @NoAuthCheck
    @RequestMapping(value = "/v2/promotion/stylers/{stylerCode}/like/add", method = RequestMethod.GET)
    public StylerPromotionLikeResponse addStylerLikeCount(@PathVariable String stylerCode, HttpSession httpSession) {

        StylerLikeDto stylerLikeDto = stylerLikeService.addStylerLikeCount(stylerCode);

        return StylerPromotionLikeResponse.create(stylerLikeDto);
    }


    @NoAuthCheck
    @MessageMapping(value = "/v3/promotion/stylers/{stylerCode}/add")
    @SendTo("/v3/promotion/stylers/like")
    public List<StylerPromotionLikeResponse> broadCasting(@DestinationVariable String stylerCode) {

        stylerLikeService.addStylerLikeCount(stylerCode);

        List<StylerLikeDto> stylerLikeDtoList = stylerLikeService.getStylersLikeCountAll();
        return StylerPromotionLikeResponse.createList(stylerLikeDtoList);
    }

```

/v2 와 /v3 비교


## AngularJS 에 적용
index.html 에 디펜던시 추가
```
        <script src="vendor/sockjs-client/dist/sockjs.js"></script>
        <script src="vendor/stomp-websocket/lib/stomp.js"></script>
```

top-styler-event.controller.js
``` js
        $scope.vm.addLike = addLike;

        $scope.client;

        function addLike($event, stylerCode) {
            $event.preventDefault();
            window.console.log(stylerCode);
            $scope.client.send("/v3/promotion/stylers/" + stylerCode + "/like/add", {}, JSON.stringify({'stylerCode': stylerCode}));

            __addFavorite(stylerCode);

        }

        function _socketInit() {
            var socket = new SockJS('/gs-guide-websocket');
            $scope.client = Stomp.over(socket);
            $scope.client.connect({}, function(frame) {
                window.console.log('connected stopmp over sockjs ', frame);
                $scope.client.subscribe('/v3/promotion/stylers/like', function(message) {
                    var data = JSON.parse(message.body);
                    __calculateLikeCount(data);
                });
            });
        }

        _socketInit();


 	// 페이지 나갈때 disconnection 해줘야 할까??
        $scope.$on("$destroy", function() {
           window.console.log("디스트로이 콜");
            if ($scope.client) {
                $scope.client.disconnect();
                window.console.log("클라이언트 디스커넥션");
            }
        });
```

## 참고
